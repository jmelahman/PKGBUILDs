name: Nightly Updates

#on:
#  schedule:
#    - cron: "0 8 * * *"
on:
  push:
    branches:
      - master

jobs:
  run-command:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
      - run: |
          git config user.name "jamison-lahman[bot]"
          git config user.email "jamison@lahman.dev"
      - run: |
          set -x
          for dir in **/; do
            MESSAGE=$(
              docker run --rm -v "$PWD:/mnt" -w "/mnt" lahmanja/nvchecker:latest \
                bash -c "chown packager -R $dir && su packager -c './pkgreleaser.py ${dir///}' && chown root -R $dir"
            )
            if [ -n "$MESSAGE" ]; then
              BRANCH="pkgreleaser/${dir}$(date +'%Y-%m-%d')"
              git checkout -b "$BRANCH" origin/master
              git commit -am "$MESSAGE"
              git push -f -u origin "$BRANCH"
              gh pr create --base master --head "$BRANCH" --fill
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
